name: Hourly AQI Forecast

on:
  schedule:
    # Runs every hour at minute 0
    - cron: '0 * * * *'
  # Allows manual runs from the Actions tab
  workflow_dispatch:

# --- FIX: ADD THIS PERMISSIONS BLOCK ---
permissions:
  contents: write # Allow the workflow to write content (commit & push)
# ------------------------------------

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for commit/push history

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          echo "Dependencies installed."

      - name: Run Forecast Script
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        run: |
          echo "Running forecast script..."
          python run_forecast_openweather.py
          echo "Script finished."

      - name: Check if forecast file exists
        run: |
          if [ -f forecasts.json ]; then
            echo "✅ forecasts.json exists."
            echo "--- File Content Preview (first 10 lines) ---"
            head -n 10 forecasts.json
            echo "---------------------------------------------"
          else
            echo "❌ ERROR: forecasts.json was NOT created by the script."
            exit 1
          fi

      - name: Check Git Status
        run: |
           echo "--- Git Status Before Commit ---"
           git status
           echo "------------------------------"

      - name: Commit and Push Forecast Data
        run: |
          echo "Configuring Git..."
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          echo "Checking for changes in forecast file..."
          git_status=$(git status --porcelain forecasts.json)

          if [ -z "$git_status" ]; then
            echo "No changes detected in forecasts.json."
          else
            echo "Changes detected ($git_status). Committing forecasts.json..."
            git add forecasts.json
            git commit -m "Update AQI forecast data"
            echo "Pushing changes..."
            git push
            echo "Changes pushed."
          fi
